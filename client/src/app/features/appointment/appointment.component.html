<div class="flex justify-center mt-8 mb-8 md:mt-16 md:mb-16 lg:mt-32 lg:mb-32">

    <div class="w-full max-w-4xl">
        <div class="text-center mb-6">
            <h1 class="text-xl md:text-2xl px-4 py-3 bg-[var(--yellow)] font-bold inline-block rounded-lg shadow-md">
                Book Your Appointment
            </h1>
        </div>
        
        <mat-stepper #stepper class="bg-[var(--white)] border border-gray-200 shadow-xl rounded-xl p-4 md:p-6">
            
            <!-- STEP 1: Select/Create Pet Profile -->
            <mat-step label="Select/Create Pet Profile">
                <form [formGroup]="appointmentForm">

                    <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-6">
                        <mat-form-field appearance="outline" class="w-full">
                            <mat-label>Select a Pet</mat-label>
                            <mat-select formControlName="petid" >
                                @for (pet of pets; track pet.id) {
                                    <mat-option [value]="pet.id">
                                        {{ pet.name }}
                                    </mat-option>
                                }
                            </mat-select>
                        </mat-form-field>
                        
                        <!-- Added margin-top to separate it on mobile when stacked -->
                        <button mat-flat-button class=" bg-[var(--primary)] text-white h-full py-4  md:mt-0 shadow-lg hover:shadow-xl transition-shadow" routerLink="/create-pet">
                            Add Pet
                        </button>
                    </div>
                </form>
                
                <div class="flex justify-between mt-8 pt-4 border-t border-gray-100">
                    <button class="flex justify-between text-indigo-600 hover:text-indigo-800 font-medium z-0" routerLink="/vets">
                        <mat-icon class="mr-1 text-base">arrow_back</mat-icon>
                        Go back to vets
                    </button>
                    <button matStepperNext mat-flat-button class="bg-[var(--primary)] text-[var(--white)] px-6 py-2 rounded-lg font-semibold shadow-md hover:bg-[var(--secondary)] transition-colors">
                        Next Step
                    </button>
                </div>
            </mat-step>
            
            <!-- STEP 2: Select Service -->
            <mat-step label="Select Service">
                <div class="text-center mt-4">
                    <form [formGroup]="servicesForm">
                        <mat-radio-group formControlName="serviceId" aria-label="Select an option"
                            class="flex flex-col md:flex-row md:flex-wrap justify-center gap-4 p-4 rounded-lg border border-gray-100">
                            @for (service of services; track service.id)
                            {
                                <mat-radio-button [value]="service.id" color="primary"
                                    class="w-full md:w-auto p-3 border rounded-lg bg-white shadow-sm hover:border-indigo-400 transition-all duration-200">
                                    <div class="text-left">
                                        <h1 class="text-lg font-medium text-gray-800">
                                            {{service.name}}
                                        </h1>
                                        <p class="text-sm text-gray-500">Starting at {{ service.price || 0.00 | currency:'PHP' }}</p>
                                    </div>
                                </mat-radio-button>
                            }
                        </mat-radio-group>
                    </form>
                    
                    <div class="flex justify-between mt-8 pt-4 border-t border-gray-100">
                        <button class="text-gray-600 hover:text-gray-800 font-medium z-0" matStepperPrevious mat-stroked-button>
                            <mat-icon class="mr-1 text-base">navigate_before</mat-icon>Back
                        </button>
                        <button matStepperNext mat-flat-button class="bg-[var(--primary)] text-[var(--white)] px-6 py-2 rounded-lg font-semibold shadow-md hover:bg-[var(--secondary)] transition-colors">
                            Next Step
                        </button>
                    </div>
                </div>
            </mat-step>
            
            <!-- STEP 3: Appointment Date -->
            <mat-step label="Appointment Date">
                <div class="mt-4">
                    <form [formGroup]="appointmentForm" class="space-y-6">
                        <div class="flex flex-col md:flex-row justify-center items-start gap-10">

                            <div class="flex justify-center w-full md:w-auto">
                                <mat-calendar
                                    [(selected)]="appointmentForm.controls['appointmentDate'].value"
                                    (selectedChange)="appointmentForm.controls['appointmentDate'].setValue($event)"
                                    [dateFilter]="isDateDisabled"
                                    [minDate]="minDate"
                                    class="border rounded-xl shadow-md p-4 w-[22rem]"
                                >
                                </mat-calendar>
                            </div>

                            <div class="grid grid-cols-2 gap-3 md:grid-cols-3">
                                @for (slot of getAvailableTimeSlot(); track $index) {
                                    <button
                                    type="button"
                                    class="p-3 rounded-lg text-center border font-semibold transition-all duration-200"
                                    [class.bg-red-500]="slot.isBooked"
                                    [class.bg-gray-300]="slot.isPast"
                                    [class.cursor-not-allowed]="slot.isPast || slot.isBooked"
                                    [class.opacity-60]="slot.isPast || slot.isBooked"
                                    [class.hover:bg-blue-100]="!slot.isPast && !slot.isBooked"
                                    [class.hover:scale-105]="!slot.isPast && !slot.isBooked"
                                    [class.bg-blue-500]="appointmentForm.value.appointmentTime === slot.time"
                                    [class.text-white]="appointmentForm.value.appointmentTime === slot.time"
                                    (click)="selectSlot(slot)"
                                    [disabled]="slot.isPast || slot.isBooked"
                                    >
                                    {{ formatTime(slot.time) }}
                                    @if (slot.isBooked) { <div class="text-xs">Booked</div> }
                                    @if (slot.isPast) { <div class="text-xs">Past</div> }
                                    </button>
                                }
                            </div>

                        </div>
                    </form>

                    <div class="flex justify-between mt-8 pt-4 border-t border-gray-100">
                        <button
                            class="text-gray-600 hover:text-gray-800 font-medium z-0"
                            matStepperPrevious mat-stroked-button
                        >
                            <mat-icon class="mr-1 text-base">navigate_before</mat-icon>Back
                        </button>

                        <button
                            mat-flat-button
                            class="bg-[var(--primary)] text-[var(--white)] px-6 py-2 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition-colors"
                            (click)="onSubmit()"
                        >
                            Submit Appointment
                        </button>
                    </div>
                </div>
            </mat-step>
            
        </mat-stepper>
    </div>
</div>